---
title: "Full-Sibling Chinook MCMC"
author: Eric C. Anderson
date: April, 2014
output: 
  html_document:
    toc: true
    highlight: pygments
  pdf_document:
    toc: true
    toc_depth: 3
    highlight: pygments
---

Note that to get this to really be a vignette, I must insert this at the top:
```
<!--
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Running on chinook data and comparing to Colony}
-->
```

```{r}
library(fullsniplings)
```

## Intro
So, are going to use the chinook full sibling data:
```{r}
dim(fs_dev_test_data$chinook_full_sibs_genos)
```
That is `r nrow(fs_dev_test_data$chinook_full_sibs_genos)` at `r ncol(fs_dev_test_data$chinook_full_sibs_genos)/2` SNPs.

## Running the chain
We can run the chain like this:
```{r}
#chinook_results <- run_mcmc(fs_dev_test_data$chinook_full_sibs_genos, burn_in = 50, num_sweeps = 200)
#save(chinook_results, file="chinook_chain_results.rda")

# i have commented that out so it doesn't take took much time, and I can get it back quickly
# like this:
load("/Users/eriq/Documents/git-repos/fullsniplings/chinook_chain_results.rda") # not portable file name
# but render() in rmarkdown seems to make the directory change...
```

## Getting the truth
Here I pull out some code from `observe_mcmc.R` to get the hashable names of the
different true sibling groups as a character vector called `true_sibgroups_as_strings`.
```{r}
ped <- fs_dev_test_data$chinook_full_sibs_pedigree
ordered.kids <- rownames(fs_dev_test_data$chinook_full_sibs_genos)
ped$kididx <- as.integer(factor(ped$Kid, levels = ordered.kids)) - 1
kid.split <- split(ped$kididx, paste(ped$Pa, "---", ped$Ma, sep=""))

# here we get a list of all the sibling groups
sibgroups <- unname(kid.split[order(sapply(kid.split, length), decreasing=T)])

# and here we can store them as strings:
true_sibgroups_as_strings <- sapply(sibgroups, function(x) paste(x, collapse="-"))
```

And, I also get a list of all the siblings that belong to each individual, in the truth:
```{r}
# now get a list of the siblings of an individual
sg.list <- vector("list", length = nrow(ped))
for(L in kid.split) {
  for(ind in L) {
    sg.list[[ind+1]] <- setdiff(L, ind)
  }
}
```
Now, if `Ind` is the base-0 index of an individual then
`sg.list[[Ind+1]]` is a vector of the base-0 indices of all of its full siblings


## Assessing results compared to the truth
Put the greedy partition results into a table with a short name, then add some columns to it:
```{r}
crtab <- chinook_results$Partition
crtab$Correct <- rownames(crtab) %in% true_sibgroups_as_strings
crtab$CumulCorrectSibs <- cumsum(crtab$NumSibs * crtab$Correct)
crtab$CumulSibsInIncorrectSibships <- cumsum(crtab$NumSibs * (1-crtab$Correct))
```
Note that the last line gives us a really punishing measure: if a sibship is incorrect, even if it is only
off by one individual, everyone in it is counted as wrong.  

There is one sibship with posterior of 1 and it is size 8, but it is wrong.  Compare these:
```{r}
# here is the row that has them
crtab["94-105-231-405-529-532-551-847", ]

# and here is what the sibship probably should look like:
c(94, sg.list[[95]])
```
I think we have seen these guys before and they are full cousins or something.


## Getting Colony's results
This will be a little weird.  I will use a previous Colony run, since I don't have time to re-run it.  That
previous run included 50 extra individuals (some half-siblings) which I will discard from the results which 
will give us something that is almost comparable.

